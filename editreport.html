<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Report - CivicTrack</title>
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

  <header class="header">
    <div class="logo">CivicTrack</div>
    <div class="user-actions">
      <a href="profile.html" class="home-btn">My Profile</a>
    </div>
  </header>

  <main class="login-container">
    <form id="editForm" class="auth-form" style="max-width: 700px;">
      <h2>✏️ Edit Your Report</h2>

      <label>Title:</label>
      <input type="text" id="title" required />

      <label>Category:</label>
      <select id="category" required>
        <option>Roads</option>
        <option>Lighting</option>
        <option>Water Supply</option>
        <option>Cleanliness</option>
        <option>Public Safety</option>
        <option>Obstructions</option>
      </select>

      <label>Description:</label>
      <textarea id="description" rows="4" required></textarea>

      <label>Location:</label>
      <p><b>Selected:</b> <span id="locationDisplay">Auto-detecting...</span></p>
      <div id="map" style="height: 300px; margin-bottom: 1rem;"></div>

      <label>Current Images:</label>
      <div id="existingImages" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:1rem;"></div>

      <label>Add New Images (optional):</label>
      <input type="file" id="newPhotos" accept="image/*" multiple />

      <div style="margin-top:1.5rem; display:flex; gap:10px;">
        <button type="submit">💾 Update Report</button>
        <button type="button" id="deleteBtn" class="logout-btn">🗑 Delete</button>
      </div>
    </form>
  </main>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="js/firebaseConfig.js"></script>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    let reportId, reportLat, reportLng, reportRef;
    const locationDisplay = document.getElementById("locationDisplay");

    // Map
    const map = L.map('map').setView([30.7333, 76.7794], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([30.7333, 76.7794]).addTo(map);

    map.on("click", e => {
      reportLat = e.latlng.lat;
      reportLng = e.latlng.lng;
      marker.setLatLng([reportLat, reportLng]);
      updateLocationDisplay();
    });

    function updateLocationDisplay() {
      locationDisplay.textContent = `${reportLat.toFixed(5)}, ${reportLng.toFixed(5)}`;
    }

    async function loadReport() {
      const params = new URLSearchParams(location.search);
      reportId = params.get("id");
      if (!reportId) return alert("No report ID");

      reportRef = db.collection("Reports").doc(reportId);
      const doc = await reportRef.get();
      if (!doc.exists) return alert("Report not found");

      const data = doc.data();
      document.getElementById("title").value = data.title;
      document.getElementById("category").value = data.category;
      document.getElementById("description").value = data.description;

      reportLat = data.lat;
      reportLng = data.lng;
      map.setView([reportLat, reportLng], 14);
      marker.setLatLng([reportLat, reportLng]);
      updateLocationDisplay();

      // Load existing images
      const imgContainer = document.getElementById("existingImages");
      (data.photoBase64 || []).forEach(b64 => {
        const img = document.createElement("img");
        img.src = b64;
        img.style.width = "150px";
        img.style.borderRadius = "6px";
        imgContainer.appendChild(img);
      });
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    document.getElementById("editForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const category = document.getElementById("category").value;
      const description = document.getElementById("description").value.trim();
      const newFiles = document.getElementById("newPhotos").files;

      let base64Images = [];

      if (newFiles.length > 0) {
        for (const file of newFiles) {
          const b64 = await toBase64(file);
          base64Images.push(b64);
        }
      }

      const update = {
        title, category, description,
        lat: reportLat, lng: reportLng,
      };
      if (base64Images.length > 0) {
        update.photoBase64 = base64Images;
      }

      await reportRef.update(update);
      alert("Report updated successfully!");
      window.location.href = "profile.html";
    });

    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this report?")) {
        await reportRef.delete();
        alert("Report deleted.");
        window.location.href = "profile.html";
      }
    });

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("You must be logged in.");
        location.href = "login.html";
        return;
      }
      loadReport();
    });
  </script>

  
</body>
</html>
